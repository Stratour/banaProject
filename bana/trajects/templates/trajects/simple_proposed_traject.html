{% extends "allauth/layouts/base.html" %}
{% load static %}

{% block head_title %}Trajet simple - BanaCommunity{% endblock %}

{% block content %}
<div class="bg-white shadow-lg rounded-xl px-4 py-8 sm:p-8 md:p-12 lg:p-16 space-y-10">

  <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900 tracking-tight mb-6">
    Proposer un trajet simplifié
  </h1>

  {% if messages %}
  <ul class="mb-4 space-y-2">
    {% for message in messages %}
    <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}
  
  {% include "./component_proposed_tabs.html" %}
  
  <form class="my-12 space-y-16" method="post" action="{% url 'simple_proposed_traject' %}">
    {% csrf_token %}
    
    <!-- Étape 1 : ville de départ -->
    <div class="flex flex-col lg:flex-row items-start gap-6 lg:gap-24">
      <img class="w-28 h-28 lg:w-40 lg:h-40 mx-auto lg:mx-0" src="{% static 'bana/img/icon/Icon_step_path.svg' %}" alt="Départ">
      
      <div class="flex-1 space-y-6 w-full">
        <div>
          <label class="block text-sm font-bold text-brand uppercase mb-1">Ville de départ</label>
          {{ form.start_adress }}
          <input type="hidden" id="start_place_id" name="start_place_id">
          <ul id="start-suggestion-list"
          class="bg-white shadow-md mt-1 max-h-48 overflow-auto"></ul>
        </div>
      </div>
    </div>
    
    <hr class="my-10">
    
    <!-- Étape 2 : informations -->
    <div class="flex flex-col lg:flex-row items-start gap-6 lg:gap-24">
      <img class="w-28 h-28 lg:w-40 lg:h-40 mx-auto lg:mx-0" src="{% static 'bana/img/icon/Icon_step_calendar.svg' %}" alt="Infos">
      
      <div class="flex-1 space-y-6 w-full">
        
        <div>
          <label class="block text-sm font-medium uppercase text-brand">Modes de transport</label>
          {{ form.transport_modes }}
        </div>
        
        <div class="flex flex-col md:flex-row gap-6">
          <div class="flex-1">
            <label class="block text-sm font-medium uppercase text-brand">Places disponibles</label>
            {{ form.number_of_places }}
            {% if form.number_of_places.errors %}
            <p class="text-sm text-red-600 mt-1">{{ form.number_of_places.errors.0 }}</p>
            {% endif %}
          </div>
          
          <div class="flex-1">
            <label class="block text-sm font-medium uppercase text-brand">{{ form.date_debut.label }}</label>
            {{ form.date_debut }}
            {% for error in form.date_debut.errors %}
            <p class="text-sm text-red-600 mt-1">{{ error }}</p>
            {% endfor %}
          </div>
        </div>
        
        <div>
          <label for="{{ form.tr_weekdays.id_for_label }}" class="block text-sm font-medium uppercase text-brand mb-2">
            {{ form.tr_weekdays.label }}
          </label>
          {{ form.tr_weekdays }}
          {% if form.tr_weekdays.errors %}
          <p class="text-sm text-red-600 mt-1">{{ form.tr_weekdays.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Bouton -->
    <div class="text-center">
      <button type="submit"
      class="w-full sm:w-auto px-6 py-3 bg-brand text-white font-semibold rounded-full hover:bg-brand-dark transition">
      Enregistrer ce trajet
    </button>
  </div>
</form>
</div>

<script>
const setupAutocomplete = (inputId, hiddenId, suggestionListId) => {
    const inputField = document.getElementById(inputId);
    const hiddenField = document.getElementById(hiddenId);
    const suggestionList = document.getElementById(suggestionListId);

    inputField.addEventListener("input", async (event) => {
        const query = inputField.value;
        if (query.length < 3) return;

        try {
            const url = `{% url 'autocomplete' %}?query=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            const data = await response.json();
            suggestionList.innerHTML = "";

            (data.suggestions || []).forEach(s => {
                const li = document.createElement("li");
                li.textContent = s.description;
                li.classList.add("cursor-pointer", "p-2", "hover:bg-gray-100");

                li.addEventListener("click", async () => {
                    inputField.value = s.description;
                    hiddenField.value = s.place_id;  // stocke le place_id
                    suggestionList.innerHTML = "";
                });
                suggestionList.appendChild(li);
            });
        } catch (err) {
            console.error(err);
        }
    });
};

// Initialisation pour start et end
setupAutocomplete("start_adress", "start_place_id", "start-suggestion-list");
setupAutocomplete("end_adress", "end_place_id", "end-suggestion-list");
</script>
{% endblock %}
