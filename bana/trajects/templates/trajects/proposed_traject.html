{% extends "allauth/layouts/base.html" %}
{% load static i18n %}

{% block head_title %}Proposer un trajet - BanaCommunity{% endblock %}

{% block content %}

<div class="bg-white shadow-lg rounded-xl px-4 py-8 sm:p-8 md:p-12 lg:p-16 space-y-10">
  <!-- max-w-5xl mx-auto px-4 py-10 -->
  <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900 tracking-tight mb-6">
    Proposer un/des trajet(s)
  </h1>
  {% if messages %}
  <ul class="mb-4 space-y-2">
    {% for message in messages %}
    <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}
  
  {% include "./component_proposed_tabs.html" %}
  
  <form class="my-12 space-y-16" method="post" action="{% url 'proposed_traject' %}">
    {% csrf_token %}

    <!-- Étape 1 : départ / arrivée -->
    <div class="flex flex-col lg:flex-row items-start gap-6 lg:gap-24">
      <img class="w-28 h-28 lg:w-40 lg:h-40 mx-auto lg:mx-0" src="{% static 'bana/img/icon/Icon_step_path.svg' %}" alt="Logo Bana">
      
      <div class="flex-1 space-y-6 w-full">
        <div>
          <label class="block text-sm font-bold text-brand uppercase mb-1">Départ</label>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
            <div class="w-full sm:w-2/3">{{ traject_form.start_adress }}
            <input type="hidden" id="start_place_id" name="start_place_id">
              <ul id="start-suggestion-list"
              class="bg-white shadow-md mt-1 max-h-48 overflow-auto"></ul>
            </div>
            
            <div class="w-full sm:w-[110px]">{{ proposed_form.departure_time }}</div>
          </div>
        </div>
      
        <div>
          <label class="block text-sm font-bold text-brand uppercase mb-1">Arrivée</label>
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
            <div class="w-full sm:w-2/3">{{ traject_form.end_adress }}
            <input type="hidden" id="end_place_id" name="end_place_id">
              <ul id="end-suggestion-list"
              class="bg-white shadow-md mt-1 max-h-48 overflow-auto"></ul>
            </div>
            
            <div class="w-full sm:w-[110px]">{{ proposed_form.arrival_time }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <hr class="my-10">
    
    <!-- Étape 2 : calendrier -->
    <div class="flex flex-col lg:flex-row items-start gap-6 lg:gap-24">
      <img class="w-28 h-28 lg:w-40 lg:h-40 mx-auto lg:mx-0" src="{% static 'bana/img/icon/Icon_step_calendar.svg' %}" alt="Logo Bana">
      
      <div class="flex-1 space-y-6 w-full">
        <div>
          <label class="block text-sm font-bold text-brand uppercase mb-1">Jours de la semaine</label>
          <div class="flex flex-wrap gap-2" id="weekday-selector">
            {% for i, day in days_of_week %}
            <label data-index="{{ i }}"
            class="w-10 h-10 flex items-center justify-center text-xs font-semibold 
            rounded-full cursor-pointer border border-gray-300 text-gray-400
            {% if i in tr_weekdays %}
            bg-brand-50 text-brand border-brand
            {% endif %}">
            {{ day|slice:":2" }}
            <input type="checkbox" name="tr_weekdays" value="{{ i }}" class="hidden"
            {% if i in tr_weekdays %}checked{% endif %}>
          </label>
          {% endfor %}
        </div>
      </div>
      
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="block text-sm font-medium uppercase text-brand">Récurrence</label>
          {% for radio in proposed_form.recurrence_type %}
          <label class="block text-sm">{{ radio.tag }} {{ radio.choice_label }}</label>
          {% endfor %}
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium uppercase text-brand">Date de début</label>
          {{ proposed_form.date_debut }}
        </div>
        <div class="flex-1" id="date_fin_container">
          <label class="block text-sm font-medium uppercase text-brand">Date de fin</label>
          {{ proposed_form.date_fin }}
        </div>
      </div>
      
      <div class="max-w-xl">
        <label class="block text-sm font-medium uppercase text-brand mb-1">
          {% trans "Moyen de transport" %}
        </label>

        <div class="flex flex-wrap gap-2">
          {% for cb in proposed_form.transport_modes %}
            <label class="inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-md border border-gray-200 hover:bg-gray-50 cursor-pointer transition">
              {{ cb.tag }}
              <span class="text-gray-700">{{ cb.choice_label }}</span>
            </label>
          {% endfor %}
        </div>

        {% if proposed_form.transport_modes.errors %}
          <p class="mt-1 text-xs text-red-600">
            {{ proposed_form.transport_modes.errors }}
          </p>
        {% endif %}
      </div>
    </div>
    </div>
  
  <hr class="my-10">
  
  <!-- Étape 3 : enfants -->
  <div class="flex flex-col lg:flex-row items-start gap-6 lg:gap-24">
    <img class="w-28 h-28 lg:w-40 lg:h-40 mx-auto lg:mx-0" src="{% static 'bana/img/icon/Icon_step_child.svg' %}" alt="Logo Bana">
    
    <div class="flex-1 space-y-6 w-full">
      <div>
        <label class="block text-sm font-bold text-brand uppercase mb-1">Enfants à accompagner</label>
        <div class="space-y-2">
          {% for checkbox in proposed_form.children %}
          <label class="inline-flex items-center space-x-2">
            {{ checkbox.tag }}
            <span>{{ checkbox.choice_label }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
      
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <label class="block text-sm font-medium uppercase text-brand">Langue(s)</label>
          {{ proposed_form.languages }}
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium uppercase text-brand">Places disponibles</label>
          {{ proposed_form.number_of_places }}
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium uppercase text-brand">Détails</label>
        {{ proposed_form.details }}
      </div>
    </div>
  </div>
  
  <!-- Bouton -->
  <div class="text-center">
    <button type="submit" class="w-full sm:w-auto px-6 py-3 bg-brand text-white font-semibold rounded-full hover:bg-brand-dark transition">
      Enregistrer le trajet
    </button>
  </div>
</form>
</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const labels = document.querySelectorAll('#weekday-selector label');
    
    labels.forEach(label => {
      label.addEventListener('click', () => {
        const input = label.querySelector('input');
        input.checked = !input.checked;
        
        label.classList.toggle('bg-brand-50', input.checked);
        label.classList.toggle('text-brand', input.checked);
        label.classList.toggle('border-brand', input.checked);
        
        label.classList.toggle('text-gray-400', !input.checked);
        label.classList.toggle('border-gray-300', !input.checked);
      });
    });

  const dateFinContainer = document.getElementById("date_fin_container");
    const recurrenceRadios = document.querySelectorAll('input[name="recurrence_type"]');
    function toggleDateFin() {
      const selected = document.querySelector('input[name="recurrence_type"]:checked');
      if (!selected) return;
      const value = selected.value;
      if (value === "weekly" || value === "biweekly") {
        dateFinContainer.style.display = "block";
      } else {
        dateFinContainer.style.display = "none";
      }
    }
    toggleDateFin();
    recurrenceRadios.forEach(radio => radio.addEventListener("change", toggleDateFin));
  });

const setupAutocomplete = (inputId, hiddenId, suggestionListId) => {
    const inputField = document.getElementById(inputId);
    const hiddenField = document.getElementById(hiddenId);
    const suggestionList = document.getElementById(suggestionListId);

    inputField.addEventListener("input", async (event) => {
        const query = inputField.value;
        if (query.length < 3) return;

        try {
            const url = `{% url 'autocomplete' %}?query=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            const data = await response.json();
            suggestionList.innerHTML = "";

            (data.suggestions || []).forEach(s => {
                const li = document.createElement("li");
                li.textContent = s.description;
                li.classList.add("cursor-pointer", "p-2", "hover:bg-gray-100");

                li.addEventListener("click", async () => {
                    inputField.value = s.description;
                    hiddenField.value = s.place_id;  // stocke le place_id
                    suggestionList.innerHTML = "";
                });
                suggestionList.appendChild(li);
            });
        } catch (err) {
            console.error(err);
        }
    });
};

// Initialisation pour start et end
setupAutocomplete("start_adress", "start_place_id", "start-suggestion-list");
setupAutocomplete("end_adress", "end_place_id", "end-suggestion-list");

document.addEventListener("DOMContentLoaded", function () {
    const dateFinContainer = document.getElementById("date_fin_container");
    const recurrenceRadios = document.querySelectorAll('input[name="recurrence_type"]');
    const weekdayCheckboxes = document.querySelectorAll('input[name="tr_weekdays"]');

    function toggleRecurrenceFields() {
        const selectedType = document.querySelector('input[name="recurrence_type"]:checked')?.value;
        const selectedDaysCount = Array.from(weekdayCheckboxes).filter(cb => cb.checked).length;

        // 1. Afficher/cacher date_fin
        if (selectedType === "weekly" || selectedType === "biweekly") {
            dateFinContainer.style.display = 'block';
        } else if (selectedType === "one_week") {
            dateFinContainer.style.display = selectedDaysCount > 1 ? 'block' : 'none';
        } else {
            dateFinContainer.style.display = 'none';
        }

        // 2. Modifier dynamiquement le texte du label "one_week"
        /*const oneWeekInput = document.querySelector('input[name="recurrence_type"][value="one_week"]');
        if (oneWeekInput) {
            const oneWeekLabel = oneWeekInput.closest("label");
            const newText = selectedDaysCount > 1 ? "Plusieurs jours" : "Un jour";

            // Supprimer les anciens noeuds après l'input
            while (oneWeekInput.nextSibling) {
                oneWeekLabel.removeChild(oneWeekInput.nextSibling);
            }

            // Ajouter le nouveau texte
            oneWeekLabel.appendChild(document.createTextNode(" " + newText));
        }*/
    }

    // Initialisation
    toggleRecurrenceFields();

    // Écouteurs d'événements
    recurrenceRadios.forEach(radio => {
        radio.addEventListener("change", toggleRecurrenceFields);
    });

    weekdayCheckboxes.forEach(checkbox => {
        checkbox.addEventListener("change", toggleRecurrenceFields);
    });
});

</script>

{% endblock %}
