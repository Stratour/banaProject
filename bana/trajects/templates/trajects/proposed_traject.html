{% extends 'layouts/base.html' %}

{% block title %}Proposer un trajet - BanaCommunity{% endblock %}

{% block content %}
    
{% include "/home/bana_community/banaProject/bana/accounts/templates/account/profile/nav_profile.html" %}

<div class="bg-gray-100 min-h-screen p-6">
    <div class="container mx-auto">

        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">üìù Proposer un trajet </h2>

        {% if messages %}
        <ul class="mb-4">
            {% for message in messages %}
            <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">
                {{ message }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        <ul class="flex border-b border-gray-300">
            <li class="mr-4">
                <a href="{% url 'proposed_traject' %}"
                    class="inline-block px-4 py-2 text-gray-700 font-medium border-b-2 border-indigo-600">
                    ‚ûï Nouveau trajet
                </a>
            </li>
            {% if request.user.profile.service == "yaya" %}
            <li class="mr-4">
            <a href="{% url 'simple_proposed_traject' %}"
                class="inline-block px-4 py-2 text-gray-600 hover:text-indigo-600 hover:border-b-2 hover:border-indigo-400 transition">
                üöº Trajet simple
            </a>
            </li>
            {% endif %}
            <li class="mr-4">
                <a href="{% url 'my_proposed_trajects' %}"
                    class="inline-block px-4 py-2 text-gray-600 hover:text-indigo-600 hover:border-b-2 hover:border-indigo-400 transition">
                    üì§ Mes propositions
                </a>
            </li>
            <li>
                <a href="{% url 'my_matchings_proposed' %}"
                    class="inline-block px-4 py-2 text-gray-600 hover:text-indigo-600 hover:border-b-2 hover:border-indigo-400 transition">
                    ü§ù Mes correspondances
                </a>
            </li>
        </ul>

        <form method="post"
            action="{% url 'proposed_traject'  %}" class="bg-white shadow-lg rounded-lg p-6 mb-6">
            {% csrf_token %}
            <fieldset>
                <legend class="text-lg font-semibold text-gray-700 mb-2">Point de d√©part</legend>
                <div class="mb-6">
                    <!--<label for="start_adress" class="block text-sm font-medium text-gray-700">
                            Adresse de d√©part
                        </label>-->
                    {{ traject_form.start_adress }}
                </div>
                <div>
                    <ul id="start-suggestion-list"
                        class="bg-white border border-gray-300 rounded-md shadow-md mt-1 max-h-48 overflow-auto"></ul>
                </div>
            </fieldset>

            <!-- Ending Point Autocomplete -->
            <fieldset>
                <legend class="text-lg font-semibold text-gray-700 mt-4 mb-2">Point d'arriv√©e</legend>
                <div class="mb-6">
                    <!--<label for="end_adress" class="block text-sm font-medium text-gray-700">
                            Adresse d'arriv√©e
                        </label>-->
                    {{ traject_form.end_adress }}
                </div>
               
                <div>
                    <ul id="end-suggestion-list"
                        class="bg-white border border-gray-300 rounded-md shadow-md mt-1 max-h-48 overflow-auto"></ul>
                </div>
            </fieldset>

            <!-- Proposed Traject Form Fields -->
            <fieldset>
                <legend class="text-lg font-semibold text-gray-700 mt-4 mb-2">Informations suppl√©mentaire</legend>
                <div class="grid grid-cols-2 gap-6">

                    {% comment "Changer la date de section" %}
                    <div class="mb-4">
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-2">Date du
                            trajet</label>
                        <input type="date" id="date" name="date"
                            class="block w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    {% endcomment %}
                    <div>
                        <label for="departure_time" class="block text-sm font-medium text-gray-700">Heure de d√©part
                        </label>
                        {{ proposed_form.departure_time }}
                    </div>
                    <div>
                        <label for="arrival_time" class="block text-sm font-medium text-gray-700">Heure d'arriv√©e
                        </label>
                        {{ proposed_form.arrival_time }}
                    </div>
                    <!--<div>
                            <label for="detour_distance" class="block text-sm font-medium text-gray-700">D√©tour (km)</label>
                            {{ proposed_form.detour_distance }}
                        </div>-->
                    <div>
                        <label for="transport_modes" class="block text-sm font-medium text-gray-700">Transport
                            Modes</label>
                        {{ proposed_form.transport_modes }}
                    </div>
                    <div>
                        <label for="languages" class="block text-sm font-medium text-gray-700">Langue(s)
                            parl√©e(s)</label>
                        {{ proposed_form.languages }}
                    </div>
                    
                    <div class="mb-4">
                      <label for="number_of_places" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ proposed_form.number_of_places.label }}
                      </label>
                      {{ proposed_form.number_of_places }}
                      {% if proposed_form.number_of_places.errors %}
                        <p class="text-sm text-red-600 mt-1">{{ proposed_form.number_of_places.errors.0 }}</p>
                      {% endif %}
                    </div>
                    
                </div>

            </fieldset>

            <fieldset>
                <!-- Jours sp√©cifiques -->
                    <div id="recurrence_days_container" class="mb-6">
                      <label class="block text-sm font-medium text-gray-700 mb-1">Jours de la semaine</label>
                      <div class="flex flex-wrap gap-4">
                        {% for i, day in days_of_week %}
                          <label class="inline-flex items-center space-x-1">
                            <input type="checkbox" name="tr_weekdays" value="{{ i }}"
                                   class="form-checkbox text-indigo-600"
                                   {% if i in tr_weekdays %}checked{% endif %}>
                            <span>{{ day }}</span>
                          </label>
                        {% endfor %}
                      </div>
                    </div>

                <!-- Type de r√©currence -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Type de r√©currence</label>
                  {% for radio in proposed_form.recurrence_type %}
                    <label class="block">
                      {{ radio.tag }}
                      {{ radio.choice_label }}
                    </label>
                  {% endfor %}
                </div>

                <!-- Date de d√©but (toujours affich√©e) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date de d√©but</label>
                    {{ proposed_form.date_debut }}
                </div>

                <!-- Date de fin (masqu√©e pour one_week) -->
                <div id="date_fin_container" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date de fin</label>
                    {{ proposed_form.date_fin }}
                </div>
            </fieldset>

            <div>
                <label for="details" class="block text-sm font-medium text-gray-700">Details</label>
                {{ proposed_form.details }}
            </div>
            <!-- Submit Button -->
            <button type="submit" class="w-full py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                üíæ Sauvegarder le trajet propos√©
            </button>
        </form>
    </div>
</div>

<script>
    document.querySelectorAll("#start_adress, #end_adress").forEach((inputField) => {
        inputField.addEventListener("input", async (event) => {
            const query = event.target.value;

            if (query.length < 3) return; // Skip queries with fewer than 3 characters

            try {
                const url = `{% url 'autocomplete' %}?query=${query}`; // Use the correct query value
                const response = await fetch(url);
                if (!response.ok) throw new Error("Error fetching suggestions");

                const data = await response.json();
                const suggestions = data.suggestions || [];

                // Determine which suggestion list to populate
                const suggestionListId = event.target.id === "start_adress" ? "start-suggestion-list" : "end-suggestion-list";
                const suggestionList = document.getElementById(suggestionListId);

                // Populate suggestions list
                suggestionList.innerHTML = ""; // Clear previous suggestions
                suggestions.forEach((suggestion) => {
                    const li = document.createElement("li");
                    li.textContent = suggestion;
                    li.classList.add("cursor-pointer", "p-2", "hover:bg-gray-100");
                    li.addEventListener("click", () => {
                        inputField.value = suggestion; // Set input value
                        suggestionList.innerHTML = ""; // Clear suggestions
                    });
                    suggestionList.appendChild(li);
                });
            } catch (error) {
                console.error("Error fetching suggestions:", error);
            }
        });
    });

document.addEventListener("DOMContentLoaded", function () {
    const dateFinContainer = document.getElementById("date_fin_container");
    const recurrenceRadios = document.querySelectorAll('input[name="recurrence_type"]');
    const weekdayCheckboxes = document.querySelectorAll('input[name="tr_weekdays"]');

    function toggleRecurrenceFields() {
        const selectedType = document.querySelector('input[name="recurrence_type"]:checked')?.value;

        // Toujours afficher les jours et date_debut
        document.getElementById("recurrence_days_container").style.display = 'block';

        // Cas normal : weekly ou biweekly ‚Üí toujours afficher date_fin
        if (selectedType === "weekly" || selectedType === "biweekly") {
            dateFinContainer.style.display = 'block';
        }

        // Cas particulier : one_week
        else if (selectedType === "one_week") {
            const selectedDays = Array.from(weekdayCheckboxes).filter(cb => cb.checked).length;
            if (selectedDays > 1) {
                dateFinContainer.style.display = 'block';
            } else {
                dateFinContainer.style.display = 'none';
            }
        }

        // Fallback
        else {
            dateFinContainer.style.display = 'none';
        }
    }

    // Initialisation
    toggleRecurrenceFields();

    // Events
    recurrenceRadios.forEach(radio => {
        radio.addEventListener("change", toggleRecurrenceFields);
    });

    weekdayCheckboxes.forEach(checkbox => {
        checkbox.addEventListener("change", toggleRecurrenceFields);
    });
});

    // Fonction pour ajuster l'affichage des champs de r√©currence selon le type choisi
    document.addEventListener("DOMContentLoaded", function () {
        const recurrenceTypeField = document.querySelector("#id_recurrence_type"); // S√©lectionner le champ "type de r√©currence"
        const recurrenceIntervalContainer = document.getElementById("recurrence_interval_container");
        const recurrenceDaysContainer = document.getElementById("recurrence_days_container");
        const dateDebutContainer = document.getElementById("date_debut_container");
        const dateFinContainer = document.getElementById("date_fin_container");

        // Fonction pour mettre √† jour l'affichage des champs de r√©currence
        function updateRecurrenceFields() {
            const recurrenceType = recurrenceTypeField.value;

            // Afficher ou masquer les champs en fonction du type de r√©currence
            if (recurrenceType === "weekly_interval") {
                recurrenceIntervalContainer.style.display = "block"; // Afficher l'intervalle de r√©currence
                recurrenceDaysContainer.style.display = "none";    // Masquer les jours sp√©cifiques
                dateDebutContainer.style.display = "block";        // Afficher la date de d√©but
                dateFinContainer.style.display = "none";          // Afficher la date de fin
            } else if (recurrenceType === "specific_days") {
                recurrenceIntervalContainer.style.display = "none"; // Masquer l'intervalle de r√©currence
                recurrenceDaysContainer.style.display = "block";    // Afficher les jours sp√©cifiques
                dateDebutContainer.style.display = "block";          // Afficher la date de d√©but
                dateFinContainer.style.display = "block";            // Afficher la date de fin
            } else {
                recurrenceIntervalContainer.style.display = "none"; // Masquer l'intervalle de r√©currence
                recurrenceDaysContainer.style.display = "none";     // Masquer les jours sp√©cifiques
                dateDebutContainer.style.display = "none";         // Afficher la date de d√©but
                dateFinContainer.style.display = "none";             // Masquer la date de fin (optionnelle)
            }
        }

        // Initialiser l'affichage en fonction de la valeur actuelle
        updateRecurrenceFields();

        // Ajouter un √©couteur d'√©v√©nement pour r√©agir aux changements du type de r√©currence
        recurrenceTypeField.addEventListener("change", updateRecurrenceFields);
    });


</script>
{% endblock %}