{% extends 'allauth/layouts/base.html' %}

{% block title %}Trajet proposé - BanaCommunity{% endblock %}

{% block content %}

<div class="bg-white shadow-lg rounded-xl px-4 py-8 sm:p-8 md:p-12 lg:p-16 space-y-10">
  
  <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900 tracking-tight mb-6">
    Mes correspondances
  </h1>

  {% if messages %}
  <ul class="mb-6">
    {% for message in messages %}
    <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">
      {{ message }}
    </li>
    {% endfor %}
  </ul>
  {% endif %}
  
  {% include "./component_researched_tabs.html" %}
  
  {% if matches %}
  <ul class="space-y-4">
    {% for match in matches %}
    <li class="bg-white shadow rounded-lg p-6 border border-brand-100">
      <h3 class="text-xl font-semibold text-gray-700 mb-2">
        Trajet prévu le {{ match.research.date|date:"l d F Y" }}
      </h3>
      {% for proposal in match.proposals %}
      <div class="border-t border-gray-200 pt-2 mt-2">
        <p class="text-sm text-gray-700">
          <strong>{{ proposal.user.profile.service | title }} :</strong> 
          {% if is_abonned == True %}
          <a href="{% url 'accounts:profile_user' user_id=proposal.user.id%}" class="text-blue-600 hover:underline">
            {% if proposal.user.profile.ci_verified %}
            {{ proposal.user.profile.verified_first_name }} {{ proposal.user.profile.verified_last_name|slice:":1" }}.
            {% else %}
            {{ proposal.user.first_name }} {{ proposal.user.last_name|slice:":1" }}.
            {% endif %}
          </a>
          {% else %} 
          <span class="text-red-700 px-4 py-3 rounded relative">Vous devez vous abonner pour pouvoir entrer en contact avec le corespondant</span>
          {% endif %}
        </p>
        <p class="text-sm text-gray-700">
          <strong>Départ :</strong> {{ proposal.traject.start_adress }} 
          {% if proposal.departure_time %} à {{ proposal.departure_time|default:"—" }}{% endif %}
        </p>
        {% if proposal.traject.end_adress %}
        <p class="text-sm text-gray-700">
          <strong>Arrivée :</strong> {{ proposal.traject.end_adress }} à {{ proposal.arrival_time|default:"—" }}
        </p>
        {% endif %}
        <p class="text-sm text-gray-700">
          <strong>Transport :</strong> 
          {% for mode in proposal.transport_modes.all %}
          {{ mode.name }}{% if not forloop.last %}, {% endif %}
          {% empty %}
          Non spécifié
          {% endfor %}
        </p>
        <p class="text-sm text-gray-700">
          <strong>Langue(s) parlée(s):</strong>
          {% if proposal.languages.all %}
          {% for language in proposal.languages.all %}
          {{ language.lang_name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
          {% else %}
          Aucune langue(s) spécifiée(s)
          {% endif %}
        </p>
        <p class="text-sm text-gray-700">
          <strong>Places disponibles :</strong> {{ proposal.number_of_places|default:"0" }}
        </p>
        <p class="text-sm text-gray-700">
          <strong>Détails :</strong> {{ proposal.details|default:"Pas de détails" }}
        </p>
        <p class="text-sm text-gray-700">
          <strong>Enfant(s) sélectionné(s) :</strong>
          {% if match.research.children.all %}
          {% for child in match.research.children.all %}
          {{ child.chld_surname }} {{ child.chld_name }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
          {% else %}
          Aucun enfant sélectionné
          {% endif %}
        </p>
        {% if match.research and match.research.id %}
        {% if proposal.number_of_places|add:'0' > 0 %}
        {% if is_abonned == True %}
        <form method="POST" action="{% url 'auto_reserve' proposal.id match.research.id %}">
          {% csrf_token %}
          <button type="submit" class="inline-flex items-center bg-green-500 gap-2 py-2 px-4 my-4 text-white hover:bg-brand-50 hover:text-brand rounded-full">
            Demander une réservation
          </button>
        </form>
        {% else %}

        <a href="{% url 'subscription' %}">
          <button type="button" class="inline-flex items-center bg-green-500 gap-2 py-2 px-4 my-4 text-white hover:bg-brand-50 hover:text-brand rounded-full">
          S'abonner
          </button>
        </a>

        {% endif %}
        {% else %}
        <p class="mt-3 inline-block px-4 py-2 bg-red-200 text-red-800 font-semibold rounded">Complet</p>
        {% endif %}
        {% endif %}
      </div>
      {% endfor %}
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <div class="rounded-xl border border-dashed border-gray-300 bg-white p-6 text-center text-gray-500">
      Vous ne recherchez aucun trajet pour l’instant.
  </div>
  {% endif %}
</div>
{% endblock %}
