{% extends 'layouts/base.html' %}

{% block title %}Créer une demande de trajet - BanaCommunity{% endblock %}

{% block content %}
    <div class="bg-gray-100 min-h-screen p-6">
        <div class="container mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Deamander un trajet</h2>
            {% if messages %}
              <ul class="mb-4">
                {% for message in messages %}
                  <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">
                    {{ message }}
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
            <!-- Search Bar -->
            <form method="POST" action="{% url 'searched_traject' %}" class="bg-white shadow-lg rounded-lg p-6 mb-6">
                {% csrf_token %}
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                               
                    <!-- Starting Point -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Point de départ -->
                        <div>
                            <label for="start_adress" class="block text-sm font-medium text-gray-700">🚀 Point de départ</label>
                            <input type="text" name="start_adress" id="start_adress" value="{{ start_adress|default:'' }}"
                                   class="w-full p-3 mt-1 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                                   placeholder="Entrez le point de départ (Adresse, ville, code postal)" autocomplete="on"/>
                        </div>
                    
                        <!-- Heure de départ -->
                        <div>
                            <label for="departure_time" class="block text-sm font-medium text-gray-700">🕒 Heure de départ</label>
                            <input type="time" name="departure_time" id="departure_time"
                                   value="{{ departure_time|default:'' }}"
                                   class="w-full p-3 mt-1 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- Bouton inverser -->
                    <div class="flex items-center justify-center pt-6">
                        <button type="button" onclick="swapAddresses()"
                                class="text-indigo-600 hover:text-indigo-800 text-xl font-bold">
                            🔄
                        </button>
                    </div>
                    <!-- Ending Point -->
                    <div>
                        <label for="end_adress" class="block text-sm font-medium text-gray-700">🎯 Point
                            d’arrivée</label>
                        <input type="text" name="end_adress" id="end_adress" value="{{ end_adress|default:'' }}"
                               class="w-full p-3 mt-1 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"
                               placeholder="Entrez le point d’arrivée (Adresse, ville, code postal)" autocomplete="on"/>
                        
                        <!-- Heure d'arrivée -->
                        <div>
                            <label for="arrival_time" class="block text-sm font-medium text-gray-700">🕒 Heure de départ</label>
                            <input type="time" name="arrival_time" id="arrival_time"
                                   value="{{ arrival_time|default:'' }}"
                                   class="w-full p-3 mt-1 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- Transport Mode -->
                    <div>
                        <label for="transport_modes" class="block text-sm font-medium text-gray-700">🚗 Mode de
                            transport</label>
                        <div class="mt-1 space-y-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="transport_modes" value="transport" class="form-checkbox" 
                                {% if "transport" in transport_modes %}checked{% endif %}>
                                <span class="ml-2">🚊 Transport en commun</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="transport_modes" value="voiture" class="form-checkbox" 
                                {% if "voiture" in transport_modes %}checked{% endif %}>
                                <span class="ml-2">🚗 Voiture</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="transport_modes" value="vélo" class="form-checkbox"
                                {% if "vélo" in transport_modes %}checked{% endif %}>
                                <span class="ml-2">🚴‍♂️ À vélo</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="transport_modes" value="pied" class="form-checkbox"
                                {% if "pied" in transport_modes %}checked{% endif %}>
                                <span class="ml-2">🚶‍♂️ À pied</span>
                            </label>
                        </div>
                    </div>

                    
                    <fieldset>
                <!-- Jours spécifiques -->
                <div id="recurrence_days_container" class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jours de la semaine</label>
                    <ul class="grid grid-cols-2 gap-2">
                        {% for i, day in days_of_week %}
                        <li>
                            <label>
                                <input type="checkbox" name="tr_weekdays" value="{{ i }}" {% if i in tr_weekdays %}checked{% endif %}>
                                {{ day }}
                            </label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Type de récurrence -->
                <legend class="block text-sm font-medium text-gray-700 mb-2">Fréquence du trajet</legend>

                <label class="block mb-2">
                    <input type="radio" name="recurrence_type" value="one_week"
                    {% if recurrence_type == 'one_week' %}checked{% endif %}>
                    Une semaine seulement
                </label>

                <label class="block mb-2">
                    <input type="radio" name="recurrence_type" value="weekly" 
                    {% if recurrence_type == 'weekly' %}checked{% endif %}>
                    Toutes les semaines
                </label>

                <label class="block mb-4">
                    <input type="radio" name="recurrence_type" value="biweekly"
                    {% if recurrence_type == 'biweekly' %}checked{% endif %}>
                    Une semaine sur deux
                </label>

                <!-- Date de début (toujours affichée) -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date de début</label>
                    <input type="date" name="date_debut"
                        value="{{ date_debut }}"
                        class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    
                </div>

                <!-- Date de fin (masquée pour one_week) -->
                <div id="date_fin_container" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date de fin</label>
                    <input type="date" name="date_fin"
                        value="{{ date_fin }}"
                        class="form-input mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                </div>
            </fieldset>
                    
                <!-- Submit Button -->
                <div class="mt-6">
                    <button type="submit"
                            class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-500 transition duration-200 shadow-md">
                        💾 Enregistrer la demande de trajet
                    </button>
                </div>
            </form>

        </div>
    </div>

    <script>
        document.querySelectorAll("#start_adress, #end_adress").forEach((inputField) => {
            inputField.addEventListener("input", async (event) => {
                const query = event.target.value;

                if (query.length < 3) return; // Skip queries with fewer than 3 characters

                try {
                    const url = `{% url 'autocomplete' %}?query=${query}`; // Use the correct query value
                    const response = await fetch(url);
                    if (!response.ok) throw new Error("Error fetching suggestions");

                    const data = await response.json();
                    const suggestions = data.suggestions || [];

                    // Determine which suggestion list to populate
                    const suggestionListId = event.target.id === "start_adress" ? "start-suggestion-list" : "end-suggestion-list";
                    const suggestionList = document.getElementById(suggestionListId);

                    // Populate suggestions list
                    suggestionList.innerHTML = ""; // Clear previous suggestions
                    suggestions.forEach((suggestion) => {
                        const li = document.createElement("li");
                        li.textContent = suggestion;
                        li.classList.add("cursor-pointer", "p-2", "hover:bg-gray-100");
                        li.addEventListener("click", () => {
                            inputField.value = suggestion; // Set input value
                            suggestionList.innerHTML = ""; // Clear suggestions
                        });
                        suggestionList.appendChild(li);
                    });
                } catch (error) {
                    console.error("Error fetching suggestions:", error);
                }
            });
        });

    document.addEventListener("DOMContentLoaded", function () {
        function toggleRecurrenceFields() {
            const selectedType = document.querySelector('input[name="recurrence_type"]:checked')?.value;

            // Toujours afficher les jours et date_debut
            document.getElementById("recurrence_days_container").style.display = 'block';

            // Afficher/Masquer uniquement date_fin
            if (selectedType === "weekly" || selectedType === "biweekly") {
                document.getElementById("date_fin_container").style.display = 'block';
            } else {
                document.getElementById("date_fin_container").style.display = 'none';
            }
        }

        toggleRecurrenceFields();

        document.querySelectorAll('input[name="recurrence_type"]').forEach(radio => {
            radio.addEventListener("change", toggleRecurrenceFields);
        });
    });

    </script>
{% endblock content%}
