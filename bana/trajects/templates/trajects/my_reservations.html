{% extends "allauth/layouts/base.html" %}
{% load static %}

{% block content %}
<div class="bg-white shadow-lg rounded-xl px-4 py-8 sm:p-8 md:p-12 lg:p-16 space-y-10">

  <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900 tracking-tight mb-6">
    Mes Réservations
  </h1>

  {% if messages %}
    <ul class="mb-6 space-y-2">
      {% for message in messages %}
        <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- ===================== RÉSERVATIONS EFFECTUÉES ===================== -->
  {% if request.user.profile.service == "Parent" %}
  <section class="space-y-4">
    <h2 class="text-sm font-bold uppercase text-brand tracking-wider">Réservations effectuées</h2>

    {% if made_reservations %}
      <div class="space-y-5">
        {% for r in made_reservations %}
          <article
            class="group rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all ring-1 ring-transparent hover:ring-brand/10">

            <!-- Header -->
            <header class="flex items-start justify-between gap-4">
              <div class="flex items-center gap-3 min-w-0">
                {# Avatar #}
                
                {% with u=r.traject.user %}
                  {% if u.profile.profile_picture %}
                  <a href="{% url 'accounts:profile_user' user_id=r.traject.user.id %}">
                    <img src="{{ u.profile.profile_picture.url }}" alt=""
                         class="h-10 w-10 rounded-full object-cover ring-2 ring-white shadow-sm">
                  </a>
                  {% else %}
                    <div class="h-10 w-10 rounded-full bg-brand/10 text-brand flex items-center justify-center font-semibold">
                      <a href="{% url 'accounts:profile_user' user_id=r.traject.user.id %}">
                        {{ u.first_name|default:u.username|slice:":1"|upper }}
                      </a>
                    </div>
                  {% endif %}
                {% endwith %}

                <div class="min-w-0">
                  <p class="text-sm text-gray-600">
                    <span class="font-semibold text-gray-900">{{ r.traject.user.profile.service|title }}</span>
                    ·
                    <a href="{% url 'accounts:profile_user' user_id=r.traject.user.id %}"
                       class="text-brand hover:underline font-medium">
                      {% if r.traject.user.profile.ci_is_verified %}
                      {{ r.traject.user.profile.verified_first_name }} {{ r.traject.user.profile.verified_last_name|slice:":1" }}.
                      {% else %}
                      {{ r.traject.user.first_name }} {{ r.traject.user.last_name|slice:":1" }}.
                      {% endif %}
                    </a>
                  </p>
                  <p class="text-xs text-gray-400 truncate">
                    Trajet #{{ r.traject.id }}
                  </p>
                </div>
              </div>

              {# Statut #}
              <div>
                {% if r.status == 'confirmed' %}
                  <span class="inline-flex items-center gap-1.5 rounded-full bg-green-50 text-green-700 border border-green-200 px-3 py-1 text-xs font-semibold">
                    <!-- check -->
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M5 13l4 4L19 7"/>
                    </svg>
                    Confirmée
                  </span>
                {% elif r.status == 'pending' %}
                  <span class="inline-flex items-center gap-1.5 rounded-full bg-yellow-50 text-yellow-700 border border-yellow-200 px-3 py-1 text-xs font-semibold">
                    <!-- clock -->
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    En attente
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1.5 rounded-full bg-red-50 text-red-700 border border-red-200 px-3 py-1 text-xs font-semibold">
                    <!-- x -->
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Annulée
                  </span>
                {% endif %}
              </div>
            </header>

            <div class="my-4 border-t border-gray-100"></div>

            <!-- Meta grid -->
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="space-y-2 text-sm text-gray-700">
                <p class="font-semibold text-gray-900 flex items-center gap-2">
                  <!-- map-pin -->
                  <svg class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z"/>
                  </svg>
                  Trajet
                </p>
                <p class="text-gray-700">
                  <span class="font-medium">{{ r.traject.traject.start_adress }}</span>
                  <span class="mx-1 text-gray-400">à</span>
                  <span class="font-medium">{{ r.traject.departure_time }}</span>
                  <span class="mx-1 text-gray-400">→</span>
                  <span class="font-medium">{{ r.traject.traject.end_adress }}</span>
                  <span class="mx-1 text-gray-400">à</span>
                  <span class="font-medium">{{ r.traject.arrival_time }}</span>
                </p>
              </div>

              <div class="space-y-2 text-sm text-gray-700">
                <p class="font-semibold text-gray-900 flex items-center gap-2">
                  <!-- calendar -->
                  <svg class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z"/>
                  </svg>
                  Date
                </p>
                <p>{{ r.traject.date|date:"l d F Y" }}</p>
              </div>

              <div class="space-y-2 text-sm text-gray-700">
                <p class="font-semibold text-gray-900 flex items-center gap-2">
                  <!-- users -->
                  <svg class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M17 20v-2a4 4 0 00-4-4H7a4 4 0 00-4 4v2"/>
                    <circle cx="9" cy="7" r="4" stroke-width="2"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M23 20v-2a4 4 0 00-3-3.87"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M16 3.13a4 4 0 010 7.75"/>
                  </svg>
                  Places
                </p>
                <p class="flex items-center gap-2">
                  <span class="inline-flex items-center rounded-full border border-gray-200 px-2.5 py-1 text-xs font-medium">
                    {{ r.number_of_places }} place(s) demandée(s)
                  </span>
                  <span class="inline-flex items-center rounded-full border border-gray-200 px-2.5 py-1 text-xs font-medium">
                    {{ r.traject.number_of_places }} place(s) restante(s)
                  </span>
                </p>
              </div>

              <div class="space-y-2 text-sm text-gray-700 sm:col-span-2">
                <p class="font-semibold text-gray-900 flex items-center gap-2">
                  <!-- car icon -->
                  <svg class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 13l2-5a2 2 0 012-1h10a2 2 0 012 1l2 5M5 13h14M6 16h.01M18 16h.01"/>
                  </svg>
                  Transport
                </p>
                <div class="mt-2 flex flex-wrap gap-2">
                  {% for mode in r.transport_modes.all %}
                    <span class="inline-flex items-center rounded-full border border-brand/30 bg-brand-50 text-brand px-2.5 py-1 text-xs font-medium">
                      {{ mode.name }}
                    </span>
                  {% empty %}
                    <span class="text-gray-400">Non spécifié</span>
                  {% endfor %}
                </div>
              </div>
            </div>

            <!-- Footer -->
            <footer class="mt-5 flex items-center justify-end">
              <a href="{% url 'accounts:profile_user' user_id=r.traject.user.id %}"
                 class="inline-flex items-center gap-2 rounded-full border border-gray-200 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand">
                Voir le profil
                <svg class="h-4 w-4 transition-transform group-hover:translate-x-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5l7 7-7 7"/>
                </svg>
              </a>
            </footer>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="rounded-xl border border-dashed border-gray-300 bg-white p-6 text-center text-gray-500">
        Aucune réservation effectuée.
      </div>
    {% endif %}
  </section>

  <hr class="my-10">
  {% endif %}
  <!-- ===================== DEMANDES REÇUES ===================== -->
  <section class="space-y-4">
    <h2 class="text-sm font-bold uppercase text-brand tracking-wider">Demandes reçues</h2>

    {% if received_reservations %}
      <div class="space-y-5">
        {% for r in received_reservations %}
          <article
            class="group rounded-2xl border border-gray-200 bg-white p-5 sm:p-6 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition-all ring-1 ring-transparent hover:ring-brand/10">

            <!-- Header -->
            <header class="flex items-start justify-between gap-4">
              <div class="flex items-center gap-3 min-w-0">
                {% with u=r.user %}
                  {% if u.profile.profile_picture %}
                    <img src="{{ u.profile.profile_picture.url }}" alt=""
                         class="h-10 w-10 rounded-full object-cover ring-2 ring-white shadow-sm">
                  {% else %}
                    <div class="h-10 w-10 rounded-full bg-brand/10 text-brand flex items-center justify-center font-semibold">
                      {{ u.first_name|default:u.username|slice:":1"|upper }}
                    </div>
                  {% endif %}
                {% endwith %}

                <div class="min-w-0">
                  <p class="text-sm text-gray-600">
                    <span class="font-semibold text-gray-900">{{ r.user.profile.service|title }}</span>
                    ·

                    {% if is_abonned %}
                    <a href="{% url 'accounts:profile_user' user_id=r.user.id %}"
                       class="text-brand hover:underline font-medium">
                      {{ r.user.first_name }} {{ r.user.last_name|slice:":1" }}.
                    </a>
                    {% else %} 
                    <span class="text-red-700 px-4 py-3 rounded relative">Vous devez vous abonner pour pouvoir entrer en contact avec le corespondant</span>
                    {% endif %}
                  </p>
                  <p class="text-xs text-gray-400 truncate">Réservation #{{ r.id }}</p>
                </div>
              </div>

              <div>
                {% if r.status == 'confirmed' %}
                  <span class="inline-flex items-center gap-1.5 rounded-full bg-green-50 text-green-700 border border-green-200 px-3 py-1 text-xs font-semibold">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                    Confirmée
                  </span>
                {% elif r.status == 'pending' %}
                  <span class="inline-flex items-center gap-1.5 rounded-full bg-yellow-50 text-yellow-700 border border-yellow-200 px-3 py-1 text-xs font-semibold">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    En attente
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1.5 rounded-full bg-red-50 text-red-700 border border-red-200 px-3 py-1 text-xs font-semibold">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    Annulée
                  </span>
                {% endif %}
              </div>
            </header>

            <div class="my-4 border-t border-gray-100"></div>

            <!-- Meta -->
            <div class="grid gap-4 sm:grid-cols-2">
              <div class="space-y-2 text-sm text-gray-700">
                <p class="font-semibold text-gray-900 flex items-center gap-2">
                  <svg class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 11c1.657 0 3-1.343 3-3S13.657 5 12 5 9 6.343 9 8s1.343 3 3 3z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 22s8-4.5 8-12a8 8 0 10-16 0c0 7.5 8 12 8 12z"/>
                  </svg>
                  Trajet
                </p>
                <p>
                  {{ r.traject.traject.start_adress }}
                  <span class="mx-1 text-gray-400">→</span>
                  {{ r.traject.traject.end_adress }}
                </p>
              </div>

              <div class="space-y-2 text-sm text-gray-700">
                <p class="font-semibold text-gray-900 flex items-center gap-2">
                  <svg class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 002-2V7H3v12a2 2 0 002 2z"/>
                  </svg>
                  Date & heures
                </p>
                <p>
                  {{ r.traject.date|date:"l d F Y" }}
                  · Départ {{ r.traject.departure_time }}
                  · Arrivée {{ r.traject.arrival_time }}
                </p>
              </div>

              <div class="space-y-2 text-sm text-gray-700 sm:col-span-2">
                <p class="font-semibold text-gray-900 flex items-center gap-2">
                  <svg class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 13l2-5a2 2 0 012-1h10a2 2 0 012 1l2 5M5 13h14M6 16h.01M18 16h.01"/>
                  </svg>
                  Transport
                </p>
                <div class="mt-2 flex flex-wrap gap-2">
                  {% for mode in r.transport_modes.all %}
                    <span class="inline-flex items-center rounded-full border border-brand/30 bg-brand-50 text-brand px-2.5 py-1 text-xs font-medium">
                      {{ mode.name }}
                    </span>
                  {% empty %}
                    <span class="text-gray-400">Non spécifié</span>
                  {% endfor %}
                </div>
              </div>
            </div>

            {% if r.status == 'pending' %}
              <footer class="mt-5 flex flex-wrap gap-3">
                {% if is_abonned %}
                <a href="{% url 'manage_reservation' r.id 'accept' %}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-brand text-white font-semibold hover:bg-brand-dark focus:outline-none focus-visible:ring-2 focus-visible:ring-brand transition">
                  <!-- check -->
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M5 13l4 4L19 7"/>
                  </svg>
                  Confirmer
                </a>
                <a href="{% url 'manage_reservation' r.id 'reject' %}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-red-300 text-red-700 hover:bg-red-50 font-semibold focus:outline-none focus-visible:ring-2 focus-visible:ring-red-300 transition">
                  <!-- x -->
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                  Refuser
                </a>
                {% else %}
                  <a href="{% url 'subscription' %}">
                    <button type="button" class="inline-flex items-center bg-green-500 gap-2 py-2 px-4 my-4 text-white hover:bg-brand-50 hover:text-brand rounded-full">
                    S'abonner
                    </button>
                  </a>
                {% endif %}
                
              </footer>
            {% endif %}
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="rounded-xl border border-dashed border-gray-300 bg-white p-6 text-center text-gray-500">
        Aucune demande reçue.
      </div>
    {% endif %}
  </section>

</div>
{% endblock %}
