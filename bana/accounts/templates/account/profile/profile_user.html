
{% extends "allauth/layouts/base.html" %}
{% load allauth i18n static %}
{% block head_title %}
{% trans "Profil de" %}  
{% if user.profile.ci_is_verified %}
  {{ user.profile.verified_first_name }}
  {{ user.profile.verified_last_name|slice:"1" }}.
{% else %}
  {{ user.first_name }} {{ user.last_name }}
{% endif %}
| Bana
{% endblock head_title %}

{% block content %}

  <!-- üîô Bouton retour -->
  <a href="javascript:history.back()" 
     class="inline-flex items-center gap-2 mb-6 rounded-full border border-gray-200 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand group transition">
    <svg class="h-4 w-4 transition-transform group-hover:-translate-x-0.5" 
         viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 19l-7-7 7-7" />
    </svg>
    <span>Retour</span>
  </a>

<div class="max-w-6xl mx-auto px-4 py-8 space-y-8">

  {% if messages %}
    <ul class="mb-6 space-y-2">
      {% for message in messages %}
        <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- üßç Profil utilisateur -->
  <div class="bg-white shadow-lg rounded-xl px-4 py-8 sm:p-8 md:p-12 lg:p-16 space-y-10">
    <h2 class="text-3xl font-bold text-brand mb-6">
      Profil de 
      {% if user.profile.ci_is_verified %}
        {{ user.profile.verified_first_name }} {{ user.profile.verified_last_name|slice:"1" }}.
      {% else %}
        {{ user.first_name }} {{ user.last_name }}
      {% endif %}
      | {{ user.profile.service|title }}
    </h2>

    <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6">
      <!-- üñºÔ∏è Avatar -->
      <div class="relative shrink-0 h-28 w-28 rounded-full bg-brand-50 ring-4 ring-[#E9F5F1] flex items-center justify-center">
        {% if user.profile.profile_picture %}
          <img src="{{ user.profile.profile_picture.url }}" alt="Photo de profil"
               class="h-full w-full rounded-full object-cover"/>
        {% else %}
          <span class="text-2xl font-bold text-brand">
            {% if user.profile.ci_is_verified %}
              {{ user.profile.verified_first_name.0 }}{{ user.profile.verified_last_name.0 }}
            {% else %}
              {{ user.first_name.0 }}{{ user.last_name.0 }}
            {% endif %}
          </span>
        {% endif %}
        {% if user.profile.prfl_is_verified %}
          <span class="absolute -top-1 -left-1 inline-flex h-8 w-8 rounded-full bg-white ring-4 ring-white shadow">
            <svg xmlns="http://www.w3.org/2000/svg" class="m-auto" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" class="text-brand" fill="currentColor" />
              <path d="M7 12l3 3 7-7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </span>
        {% endif %}
      </div>

      <!-- ‚ÑπÔ∏è Infos utilisateur principales -->
  <div class="flex-1 max-w-[500px] sm:ml-6 space-y-2">
    <p class="text-lg"><strong>Email :</strong> {{ user.email }}</p>
    <p class="text-lg"><strong>Ville :</strong> {{ user.profile.address }}</p>
    <p class="text-lg"><strong>Langue(s) :</strong>
      {% for language in user.profile.languages.all %}
        {{ language.lang_abbr }}{% if not forloop.last %}, {% endif %}
      {% endfor %}
    </p>
    {% if user.profile.bio %}
      <p class="text-lg"><strong>Bio :</strong> {{ user.profile.bio }}</p>
    {% endif %}
  </div>

  <!-- üìÖ Infos de compte -->
  <div class="min-w-[220px] md:text-right">
    <p class="text-gray-500"><strong>Membre depuis le </strong><br>{{ user.date_joined|date:"d F Y" }}</p>
    <p class="text-gray-500"><strong>Derni√®re connexion :</strong><br>{{ user.last_login|date:"d M Y H:i" }}</p>
  </div>
</div>
  </div>

  <!-- ‚≠ê Section Avis -->
  <div class="bg-white shadow-lg rounded-xl px-4 py-8 sm:p-8 md:p-12 lg:p-16 space-y-10">
    <h2 class="text-3xl font-bold text-gray-800 mb-6">Avis</h2>

    {% if reviews_count > 0 %}
      <div class="flex items-center gap-2 mb-4">
        <strong>Note moyenne :</strong>
        {% for i in "12345" %}
              {% if forloop.counter <= full_stars %}
                <svg class="h-6 w-6 text-brand" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" aria-hidden="true">
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              {% elif forloop.counter == full_stars|add:'1' and has_half_star %}
                <!-- Demi-√©toile SVG -->
                <svg class="h-6 w-6 text-brand" viewBox="0 0 24 24" fill="url(#half)" stroke="url(#half)" aria-hidden="true">
                <defs>
                  <linearGradient id="half">
                    <stop offset="50%" stop-color="#007F73" />
                    <stop offset="50%" stop-color="#D1D5DB" />
                  </linearGradient>
                </defs>
                <path fill="url(#half)" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />

              </svg>
              {% else %}
                <!-- √âtoile vide -->
              <svg class="h-6 w-6 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              {% endif %}
            {% endfor %}
        <span class="ml-2 text-gray-600">({{ average_rating|floatformat:"1" }}/5, {{ reviews_count }} avis)</span>
      </div>
    {% else %}
      <p class="text-gray-500"><strong>Note moyenne :</strong> Pas encore d‚Äôavis</p>
    {% endif %}

<!-- üìã Liste des avis -->
<h3 class="text-2xl font-semibold text-gray-700 mt-6 mb-3">Avis re√ßus</h3>

<ul class="bg-gray-50 p-4 rounded-md shadow-sm space-y-3">
  {% for review in reviews %}
    {% with full_stars=review.rating|floatformat:0 has_half_star=False %}
      <li class="border-b last:border-none pb-3">
        <div class="flex items-center justify-between">
          <div class="flex flex-col sm:flex-row sm:items-center sm:gap-2">
            <a href="{% url 'accounts:profile_user' user_id=review.reviewer.id %}" class="text-blue-600 hover:underline font-semibold">
              {% if review.reviewer.profile.ci_is_verified %}
                {{ review.reviewer.profile.verified_first_name }} {{ review.reviewer.profile.verified_last_name|slice:'1' }}. :
              {% else %}
                {{ review.reviewer.first_name }} {{ review.reviewer.last_name|slice:'1' }}. :
              {% endif %}
            </a>

            <div class="flex items-center space-x-1">
              {% for i in "12345" %}
                {% if forloop.counter <= review.rating %}
                  <!-- √âtoile pleine -->
                  <svg class="h-5 w-5 text-brand" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" aria-hidden="true">
                    <path
                      d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                {% else %}
                  <!-- √âtoile vide -->
                  <svg class="h-5 w-5 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                    <path
                      d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
                      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                {% endif %}
              {% endfor %}
              <span class="ml-2 text-sm text-gray-600">{{ review.rating }}/5</span>
            </div>
          </div>
        </div>

        <p class="italic text-gray-700 mt-1">"{{ review.comment }}"</p>
      </li>
    {% endwith %}
  {% empty %}
    <p class="text-gray-500">Aucun avis pour le moment.</p>
  {% endfor %}
</ul>

<!-- üìù Formulaire d‚Äôavis -->
{% if allow_review %}
  <h3 class="text-2xl font-semibold text-gray-700 mt-8 mb-3">Laisser un avis</h3>
  <form method="post" class="bg-gray-50 p-4 rounded-md shadow-sm space-y-4">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="bg-brand text-white px-4 py-2 rounded-full font-bold hover:bg-brand-600 transition">
      Laisser un avis
    </button>
  </form>

{% elif existing_review %}
  <h3 class="text-2xl font-semibold text-gray-700 mt-8 mb-3">Votre avis</h3>

  {% if is_editing %}
  <form method="post" class="bg-gray-50 p-4 rounded-md shadow-sm space-y-4">
    {% csrf_token %}
    {{ form.as_p }}
    <div class="flex items-center gap-3" id="avis-section">
      <button type="submit" class="bg-brand text-white px-4 py-2 rounded-full font-bold hover:bg-brand-600 transition">
        Sauvegarder
      </button>
      <a href="{% url 'accounts:profile_user' user.id %}"
         class="text-red-500 hover:text-red-700 hover:underline">
         Annuler
      </a>
    </div>
  </form>
  {% else %}
    <div class="flex items-center mt-2 space-x-2">
      <!-- Syst√®me d‚Äô√©toiles -->
      {% for i in "12345" %}
        {% if forloop.counter <= existing_review.rating %}
          <!-- √âtoile pleine -->
          <svg class="h-6 w-6 text-brand" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" aria-hidden="true">
            <path
              d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        {% else %}
          <!-- √âtoile vide -->
          <svg class="h-6 w-6 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
            <path
              d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"
              stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        {% endif %}
      {% endfor %}
      <span class="text-gray-700 text-sm ml-2">({{ existing_review.rating }}/5)</span>
    </div>

    <p class="italic text-gray-700 mt-1">"{{ existing_review.comment }}"</p>

    <div class="mt-3 flex gap-3">
      <a href="?edit_review=true#avis-section"
         class="inline-flex items-center px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200 transition">
        ‚úèÔ∏è Modifier
      </a>
      <a href="{% url 'accounts:delete_review' user_id=user.id %}"
         class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-700 hover:bg-red-200 transition">
        ‚ùå Supprimer
      </a>
    </div>
  {% endif %}
{% endif %}
  </div>

</div>
{% endblock content %}

