{% extends "allauth/layouts/base.html" %}
{% load allauth i18n static %}

{% block head_title %}{% trans "Sécurité & connexion" %}{% endblock head_title %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-10">

  <header class="mb-6">
    <h1 class="text-2xl sm:text-3xl font-semibold text-gray-900 tracking-tight">
      {% trans "Sécurité & connexion" %}
    </h1>
  </header>

  {% if messages %}
    <ul class="mb-6 space-y-2">
      {% for message in messages %}
        <li class="text-sm p-2 rounded bg-yellow-100 text-yellow-900">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <article class="group rounded-2xl border border-gray-200 bg-white p-6 sm:p-8 md:p-10 shadow-sm hover:shadow-md transition-all ring-1 ring-transparent hover:ring-brand/10">

    {# ========= Adresse e-mail ========= #}
<section class="space-y-4">
  <h2 class="text-sm font-bold uppercase text-brand tracking-wider">{% trans "Adresse e-mail" %}</h2>

  <div class="rounded-xl border border-gray-200 p-4">
    <p class="text-sm text-gray-700">
      <span class="font-semibold text-gray-900">{% trans "Adresse e-mail actuelle" %} :</span>
      <span class="ml-1 text-gray-900">{{ request.user.email }}</span>

      {% with emails=request.user.emailaddress_set.all %}
        {% for e in emails %}
          {% if e.email == request.user.email %}
            {% if e.verified %}
              <span class="ml-2 inline-flex items-center rounded-full bg-green-50 text-green-700 border border-green-200 px-2 py-0.5 text-xs font-semibold">
                {% trans "Vérifiée" %}
              </span>
            {% else %}
              <span class="ml-2 inline-flex items-center rounded-full bg-yellow-50 text-yellow-700 border border-yellow-200 px-2 py-0.5 text-xs font-semibold">
                {% trans "Non vérifiée" %}
              </span>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endwith %}
    </p>
  </div>

  <form method="post" action="{% url 'accounts:email_edit' %}" class="space-y-3 max-w-md">
    {% csrf_token %}
    <label class="block text-sm font-semibold text-gray-900">{% trans "Changer d’e-mail" %}</label>
    
    {# Champ pour saisir le nouvel email #}
    <input type="email" name="email" required
           placeholder="{% trans 'nouvelle adresse e-mail' %}"
           class="mt-1 w-full border border-brand px-4 py-2 shadow-sm rounded-full focus:ring-brand focus:border-brand" />
    
    {# Bouton soumettre #}
    <div class="flex items-center gap-3 pt-1">
      <button type="submit"
              class="inline-flex items-center gap-2 rounded-full bg-brand text-white px-5 py-2 text-sm font-semibold hover:bg-brand-dark focus:outline-none focus-visible:ring-2 focus-visible:ring-brand">
        {% trans "Mettre à jour" %}
      </button>
    </div>
  </form>

  {# Formulaire pour renvoyer le mail de confirmation #}
  {% comment "" %}
  <form method="post" action="{% url 'accounts:email_edit' %}" class="pt-1">
    {% csrf_token %}
    <input type="hidden" name="resend" value="1">
    <button type="submit"
            class="inline-flex items-center gap-2 rounded-full border border-yellow-300 text-yellow-800 px-4 py-1.5 text-sm font-semibold hover:bg-yellow-50">
      {% trans "Renvoyer la vérification" %}
    </button>
  </form>
  {% endcomment %}
</section>

    <div class="border-t border-gray-100 my-4"></div>

    {# ========= Mot de passe ========= #}
    <section class="space-y-4">
      <h2 class="text-sm font-bold uppercase text-brand tracking-wider">{% trans "Mot de passe" %}</h2>

      {# NB: CustomPasswordChangeView (allauth) attend oldpassword/password1/password2 #}
      <form method="post" action="{% url 'accounts:account_change_password' %}" class="space-y-4 max-w-md">
        {% csrf_token %}

        <div>
          <label class="block text-sm font-semibold text-gray-900 mb-1">{% trans "Mot de passe actuel" %}</label>
          <input type="password" name="oldpassword" autocomplete="current-password" required
                 class="w-full border border-brand px-4 py-2 shadow-sm rounded-full focus:ring-brand focus:border-brand" />
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-900 mb-1">{% trans "Nouveau mot de passe" %}</label>
          <input type="password" name="password1" autocomplete="new-password" required
                 class="w-full border border-brand px-4 py-2 shadow-sm rounded-full focus:ring-brand focus:border-brand" />
          <p class="mt-1 text-xs text-gray-500">{% trans "8 caractères minimum, mélangez lettres/chiffres/symboles." %}</p>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-900 mb-1">{% trans "Confirmer le nouveau mot de passe" %}</label>
          <input type="password" name="password2" autocomplete="new-password" required
                 class="w-full border border-brand px-4 py-2 shadow-sm rounded-full focus:ring-brand focus:border-brand" />
        </div>

        <div class="flex items-center justify-between pt-2">
          <a href="{% url 'account_reset_password' %}" class="text-sm text-brand hover:underline">
            {% trans "Mot de passe oublié ?" %}
          </a>
          <button type="submit"
                  class="inline-flex items-center gap-2 rounded-full bg-brand text-white px-5 py-2 text-sm font-semibold hover:bg-brand-dark focus:outline-none focus-visible:ring-2 focus-visible:ring-brand">
            {% trans "Mettre à jour" %}
          </button>
        </div>
      </form>
    </section>

    <div class="border-t border-gray-100 my-4"></div>

    {# ========= Danger zone ========= #}
    <section class="space-y-3">
      <h2 class="text-sm font-bold uppercase tracking-wider text-red-600">{% trans "Zone sensible" %}</h2>
      <p class="text-sm text-gray-600">{% trans "Désactivez votre compte. Un administrateur devra le réactiver pour reprendre l'accès." %}</p>

      <button type="button"
              onclick="document.getElementById('deactivate-modal').showModal()"
              class="inline-flex items-center gap-2 rounded-full border border-red-300 text-red-700 px-4 py-2 text-sm font-semibold hover:bg-red-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-red-300">
        {% trans "Supprimer mon compte" %}
      </button>
    </section>
  </article>
</div>

{# ========= Modal désactivation ========= #}
<dialog id="deactivate-modal" class="rounded-xl p-0 w-full max-w-md">
  <form method="post" action="{% url 'accounts:deactivate_account' %}" class="p-6 space-y-5">
    {% csrf_token %}
    <header class="space-y-1">
      <h3 class="text-lg font-semibold text-red-600">{% trans "Désactiver le compte" %}</h3>
      <p class="text-sm text-gray-600">{% trans "Vous ne pourrez plus vous connecter sans réactivation par un administrateur." %}</p>
    </header>

    <div class="flex items-center justify-end gap-3 pt-2">
      <button type="button"
              onclick="document.getElementById('deactivate-modal').close()"
              class="inline-flex items-center gap-2 rounded-full border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand">
        {% trans "Annuler" %}
      </button>
      <button type="submit"
              class="inline-flex items-center gap-2 rounded-full bg-red-600 text-white px-4 py-2 text-sm font-semibold hover:bg-red-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-red-300">
        {% trans "Confirmer" %}
      </button>
    </div>
  </form>
</dialog>

<style>
  #deactivate-modal::backdrop { background: rgba(0,0,0,.4); }
</style>
{% endblock content %}
